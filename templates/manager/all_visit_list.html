{% extends "manager/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
  {% include "manager/sidebar.html" %}
  <div class="main-panel">
    <div class="main-header">
      {% include "manager/nav.html" %}
    </div>

    <div class="container">
      <div class="page-inner">
        <div class="container mt-4">
          <h3 class="mb-3">All Visits</h3>

          <!-- üîç Filter + Buttons Row -->
          <form method="get" class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Created Date</label>
              <input type="date" name="created_date" class="form-control" value="{{ created_date }}">
            </div>
            
            <div class="col-md-8 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Filter</button>
    <a href="{% url 'all_visit_list' %}" class="btn btn-secondary">Reset</a>
    <a href="{% url 'export_visits_pdf' %}?{% if created_date %}created_date={{ created_date }}{% endif %}" 
       class="btn btn-success">Download PDF</a>
  </div>
          </form>

          <!-- üìä Totals -->
          <div class="mb-4">
            {% if created_date %}
              <h5 class="fw-bold text-primary">Total Quoted Orders on {{ created_date }}:</h5>
            {% else %}
              <h5 class="fw-bold text-primary">Total Quoted Orders (All Time):</h5>
            {% endif %}
            <p class="fs-5">
              <span class="fw-bold">{{ total_quoted_count|default:"0" }}</span> orders, 
              total amount = 
              <span class="fw-bold">
                {{ total_order_amount|default:"0"|floatformat:2|intcomma }}
              </span>
            </p>
          </div>

          <h4 class="mb-3">Visits ({{ visits.paginator.count }})</h4>
          <hr>

          {% if visits %}
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle w-100 custom-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Production Line</th>
                  <th>Client / Company</th>
                  <th>Contact Person</th>
                  <th>Contact Number</th>
                  <th>Designation</th>
                  <th>Location</th>
                  <th>Meeting Purpose</th>
                  <th>Outcome</th>
                  <th>Item Discussed</th>
                  <th>Order Quoted</th>
                  <th>Order Amount</th>
                  <th>Reason (if No Order)</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody>
                {% for v in visits %}
                <tr>
                  <td>{{ forloop.counter0|add:visits.start_index }}</td>
                  <td>{{ v.get_productionline_display }}</td>
                  <td>{{ v.company_name }}</td>
                  <td>{{ v.contact_person }}</td>
                  <td>{{ v.contact_number }}</td>
                  <td>{{ v.designation }}</td>
                  <td>
                    {% if v.latitude and v.longitude %}
                      üìç {{ v.place_name }}
                      <small>{{ v.region }} {{ v.zone }} {{ v.nation }}</small><br>
                      <a href="https://www.google.com/maps/search/?api=1&query={{ v.latitude }},{{ v.longitude }}"
                         target="_blank" class="ms-1 text-decoration-none">[View on Map]</a>
                    {% else %}
                      <span class="text-muted">Not Available</span>
                    {% endif %}
                  </td>
                  <td>{{ v.meeting_purpose }}</td>
                  <td>{{ v.meeting_outcome }}</td>
                  <td>{{ v.item_discussed }}</td>
                  <td>
                    {% if v.is_order_quoted %}
                      <span class="badge bg-success">Yes</span>
                    {% else %}
                      <span class="badge bg-danger">No</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if v.is_order_quoted %}
                      {{ v.order_amount|default:"0"|floatformat:2|intcomma }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ v.reason_no_order|default:"N/A" }}</td>
                  <td>{{ v.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- üîÄ Pagination -->
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
              {% if visits.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if created_date %}&created_date={{ created_date }}{% endif %}">¬´ First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ visits.previous_page_number }}{% if created_date %}&created_date={{ created_date }}{% endif %}">‚Äπ Prev</a>
                </li>
              {% endif %}

              <li class="page-item active">
                <span class="page-link">
                  Page {{ visits.number }} of {{ visits.paginator.num_pages }}
                </span>
              </li>

              {% if visits.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ visits.next_page_number }}{% if created_date %}&created_date={{ created_date }}{% endif %}">Next ‚Ä∫</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ visits.paginator.num_pages }}{% if created_date %}&created_date={{ created_date }}{% endif %}">Last ¬ª</a>
                </li>
              {% endif %}
            </ul>
          </nav>

          {% else %}
            <p>No visits found.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <style>
    .custom-table td, 
    .custom-table th {
      white-space: nowrap;
      vertical-align: middle;
      padding: 8px 12px;
    }
    .custom-table thead th {
      background: none !important;
      font-weight: 600;
      border-bottom: 2px solid #ccc;
    }
    .custom-table tbody tr {
      background: none !important;
    }

    /* ‚úÖ Make button group wrap neatly on small devices */
    .d-flex.flex-wrap.gap-2 a, 
    .d-flex.flex-wrap.gap-2 button {
      flex: 1 1 auto;
    }
  </style>
{% endblock %}
